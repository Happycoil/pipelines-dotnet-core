parameters:
- name: url
  type: string
- name: port
  type: string
- name: aggressiveMode
  type: boolean

steps:
- task: owaspzap@1
  inputs:
    scantype: 'targetedScan'
    url: ${{ parameters.url }}
    port: ${{ parameters.port }}
    aggressivemode: ${{ parameters.aggressiveMode }}
  displayName: 'Run OWASP ZAP'
- bash: |
    sudo npm install -g handlebars-cmd

    cat <<EOF > owaspzap/nunit-template.hbs
    {{#each site}}

    <test-run
        id="2"
        name="Owasp test"
        start-time="{{../[@generated]}}"  >
        <test-suite
            id="{{@index}}"
            type="Assembly"
            name="{{[@name]}}"
            result="Failed"
            failed="{{alerts.length}}">
            <attachments>
                <attachment>
                    <filePath>$(System.DefaultWorkingDirectory)/owaspzap/report.html</filePath>
                </attachment>
            </attachments>
        {{#each alerts}}<test-case
            id="{{@index}}"
            name="{{alert}}"
            result="Failed"
            fullname="{{alert}}"
            time="1">
                <failure>
                    <message>
                        <![CDATA[{{{desc}}}]]>
                    </message>
                    <stack-trace>
                        <![CDATA[
    Solution:
    {{{solution}}}

    Reference:
    {{{reference}}}

    instances:{{#each instances}}
    * {{uri}}
        - {{method}}
        {{#if evidence}}- {{{evidence}}}{{/if}}
                        {{/each}}]]>
                    </stack-trace>
                </failure>
        </test-case>
        {{/each}}
        </test-suite>
    </test-run>
    {{/each}}
    EOF
  displayName: 'Generate NUnit Template'
  condition: always()
- bash: 'handlebars owaspzap/report.json < owaspzap/nunit-template.hbs > owaspzap/test-results.xml'
  displayName: 'Generate NUnit Report'
  condition: always()
- pwsh: |
    (Get-Content -Raw -Path ./owaspzap/test-results.xml) -split '<\/test-run>' | ForEach {
      if(($_).Trim() -notmatch '^$'){
        Set-Content -Path "./owaspzap/test-results-$(get-random).xml" -Value "$_</test-run>"
      }
    }
    Remove-Item -Path ./owaspzap/test-results.xml
  displayName: 'Split Pages To Multiple NUnit Test Runs'
  condition: always()
- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  inputs:
    testResultsFormat: NUnit
    testResultsFiles: 'owaspzap/test-results-*.xml'
    mergeTestResults: true
    testRunTitle: OWASP ZAP Test Results
  condition: always()