parameters:
- name: url
  type: string
- name: port
  type: string
- name: aggressive
  type: boolean

steps:
- pwsh: |
    $zapScript = 'zap-baseline.py'
    if ("${{ parameters.aggressive }}" -eq 'True') {
      $zapScript = 'zap-full-scan.py'
    }
    $owaspWorkingFolder = New-Item -ItemType Directory -Path "$(System.DefaultWorkingDirectory)/owaspzap" | Select -Exp FullName
    /usr/bin/docker run -u 0 -v ${owaspWorkingFolder}:/zap/wrk/:rw owasp/zap2docker-stable $zapScript -t ${{ parameters.url }}:${{ parameters.port }} -J report.json -r report.html
    sudo npm install -g handlebars-cmd

    Set-Content -Path $owaspWorkingFolder/nunit-template.hbs -Value (@'
    {{#each site}}

    <test-run
        id="2"
        name="Owasp test"
        start-time="{{../../[@generated]}}">
        <test-suite
            id="{{@index}}"
            type="Assembly"
            name="{{[@name]}}"
            result="Failed"
            failed="{{alerts.length}}">
            <attachments>
                <attachment>
                    <filePath>$(System.DefaultWorkingDirectory)/owaspzap/report.html</filePath>
                </attachment>
                <attachment>
                    <filePath>$(System.DefaultWorkingDirectory)/owaspzap/report.json</filePath>
                </attachment>
            </attachments>
        {{#each alerts}}<test-case
            id="{{@index}}"
            name="{{alert}}"
            result="Failed"
            fullname="{{alert}}"
            time="1">
                <failure>
                    <message>
                        <![CDATA[{{{desc}}}]]>
                    </message>
                    <stack-trace>
                        <![CDATA[
    Solution:
    {{{solution}}}

    Reference:
    {{{reference}}}

    instances:{{#each instances}}
    * {{uri}}
        - {{method}}
        {{#if evidence}}- {{{evidence}}}{{/if}}
                        {{/each}}]]>
                    </stack-trace>
                </failure>
        </test-case>
        {{/each}}
        </test-suite>
    </test-run>
    {{/each}}
    '@)

    Get-Content -Raw -Path $owaspWorkingFolder/nunit-template.hbs | handlebars $owaspWorkingFolder/report.json > $owaspWorkingFolder/test-results.xml
    (Get-Content -Raw -Path $owaspWorkingFolder/test-results.xml) -split '<\/test-run>' | ForEach {
      if(($_).Trim() -notmatch '^$'){
        $content = $_ -replace '<p>', '' -replace '</p>', ''
        $resTmpFile = "$owaspWorkingFolder/test-results-$(get-random).xml"
        Set-Content -Path $resTmpFile -Value "$content</test-run>"
      }
    }
    Remove-Item -Path $owaspWorkingFolder/test-results.xml
  displayName: 'Run OWASP ZAP'
- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  inputs:
    testResultsFormat: NUnit
    testResultsFiles: "$(System.DefaultWorkingDirectory)/**/test-results-*.xml"
    mergeTestResults: true
    testRunTitle: OWASP ZAP Test Results
  condition: always()